<div keyboard-listener>
    <panel position="left"></panel>
    <panel position="top"></panel>
    <panel position="right"></panel>
    <svg width="100%" height="100%" viewBox="0 0 1200 675"
         preserveAspectRatio="xMidYMid meet"
         xmlns="http://www.w3.org/2000/svg" tool-controller
         draw-tool line-tool arrow-tool text-tool list-tool rect-tool circle-tool
         class="{{ tool.selectedTool }}">
        <rect height="100%" width="100%" fill="white" />
        <g ng-repeat="node in cmp.page.nodes"
           ng-attr-transform="translate({{ node.x }},{{ node.y }})" node-handler="node">
            <g>
                <polyline ng-if="node.type == 'freehand'"
                          ng-attr-points="{{ node.freehand }}" fill="none"
                          stroke="{{ node.color }}" stroke-width="{{ node.width }}" />

                <path ng-if="node.type == 'line'"
                      stroke="{{ node.color }}" stroke-width="{{ node.width }}" fill="none"
                      ng-attr-d="M {{ node.start.x }} {{ node.start.y }} L {{ node.end.x }} {{ node.end.y }}" />

                <polygon ng-if="node.type == 'arrow'" arrow=""
                         fill="{{ node.color }}" stroke="none"
                         ng-attr-points="{{ arrow.points }}" />

                <path ng-if="node.type == 'path'"
                      stroke="{{ node.color }}" stroke-width="{{ node.width }}"
                      fill="none" ng-attr-d="{{ node.path }}" />

                <g ng-if="node.type == 'text'">
                    <g ng-show="node.editing">
                        <foreignobject ng-attr-height="{{ node.size + 10 }}"
                                       ng-attr-width="{{ node.size * (node.text.length + 1) }}">
                            <input type="text" ng-model="node.text"
                                   style="width: {{ node.size * (node.text.length + 1) }}px;color: {{ node.color }};
                                          font-size: {{ node.size }}px;" />
                        </foreignobject>
                    </g>
                    <text ng-hide="node.editing"
                          fill="{{ node.color }}" font-size="{{ node.size }}" ng-attr-y="{{ node.size }}">
                        {{ node.text }}
                    </text>
                </g>

                <g ng-if="node.type == 'basicList'">
                    <g ng-if="node.listType == 'unordered'">
                        <g ng-repeat="row in node.rows track by $index">
                            <circle ng-attr-r="{{ node.scale(0.2) }}" ng-attr-cx="{{ node.scale(0.3) }}"
                                    ng-attr-cy="{{ node.scale($index + 1) - node.scale(0.3) }}"
                                    fill="{{ node.color }}" />
                        </g>
                    </g>
                    <g ng-if="node.listType == 'ordered'">
                        <g ng-repeat="row in node.rows track by $index">
                            <text text-anchor="end"
                                  ng-attr-x="{{ node.scale(0.5) + 5 }}" ng-attr-y="{{ node.scale($index + 1) }}"
                                  fill="{{ node.color }}" ng-attr-font-size="{{ node.scale(0.8) }}">
                                {{ $index + 1 }}
                            </text>
                        </g>
                    </g>
                    <g ng-if="node.listType == 'checked'">
                        <g ng-repeat="row in node.rows track by $index" checkbox
                           ng-attr-transform="translate(0,{{ node.scale($index) + node.scale(0.4) }})">
                            <path ng-if="checkbox.checked"
                                  ng-attr-stroke-width="{{ node.scale(0.1) }}" stroke="{{ node.color }}"
                                  ng-attr-d="M 0 0 L {{ node.scale(0.6) }} {{ node.scale(0.6) }}
                                             M 0 {{ node.scale(0.6) }} L {{ node.scale(0.6) }} 0" />
                            <rect ng-attr-height="{{ node.scale(0.6) }}" ng-attr-width="{{ node.scale(0.6) }}"
                                  x="0" y="0" fill="transparent"
                                  stroke="{{ node.color }}" ng-attr-stroke-width="{{ node.scale(0.1) }}" />
                        </g>
                    </g>
                    <g ng-show="node.editing">
                        <foreignobject ng-attr-height="{{ node.size * (node.rows.length + 1) + 10 }}"
                                       ng-attr-width="200" ng-attr-x="{{ node.scale(0.55) }}">
                            <textarea ng-model="node.text"
                                      style="height: {{ node.size * node.rows.length + 10 }}px;
                                             min-height: {{ node.size + 10 }}px;
                                             color: {{ node.color }}; font-size: {{ node.size }}px;">
                            </textarea>
                        </foreignobject>
                    </g>
                    <g ng-hide="node.editing" ng-repeat="row in node.rows track by $index">
                        <text fill="{{ node.color }}" font-size="{{ node.size }}"
                              ng-attr-x="{{ node.scale(0.65) + 5 }}" ng-attr-y="{{ node.scale($index + 1) }}">
                            {{ row | removeLeading:'*' }}
                        </text>
                    </g>
                </g>

                <rect ng-if="node.type == 'rect'" x="0" y="0"
                      stroke="{{ node.strokeColor }}" stroke-width="{{ node.strokeWidth }}" fill="{{ node.fillColor }}"
                      ng-attr-height="{{ node.height }}" ng-attr-width="{{ node.width }}" />

                <circle ng-if="node.type == 'circle'" x="0" y="0"
                        stroke="{{ node.strokeColor }}" stroke-width="{{ node.strokeWidth }}"
                        fill="{{ node.fillColor }}" ng-attr-r="{{ node.radius }}" />
            </g>
            <g ng-if="tool.selectedNode == node">
                <circle r="5" cx="-5" cy="-5" />
                <circle r="5" ng-attr-cx="{{ nodeHandler.width + 5 }}" cy="-5" />
                <circle r="5" cx="-5" ng-attr-cy="{{ nodeHandler.height + 5 }}" />
                <circle r="5" ng-attr-cx="{{ nodeHandler.width + 5 }}" ng-attr-cy="{{ nodeHandler.height + 5 }}" />
            </g>
        </g>
    </svg>
</div>
